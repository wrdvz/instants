---
import { Client } from "@notionhq/client";
import "../styles/main.css";

const { NOTION_API_KEY, NOTION_DATABASE_ID } = Astro.locals.runtime.env;

const notion = new Client({ auth: NOTION_API_KEY });

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: { property: "Published", checkbox: { equals: true } },
  sorts: [{ property: "Order", direction: "ascending" }],
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      images: imageProp.files.map(f => f.file?.url || f.external?.url),
    };
  })
  .filter(Boolean);
---
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <!-- FEED -->
    <main class="feed">
      {instants.map(i => (
        <img
          src={i.images[0]}
          alt={i.title}
          loading="eager"
          data-images={JSON.stringify(i.images)}
        />
      ))}
    </main>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="lightbox">
      <button class="close">←</button>
      <button class="nav prev">‹</button>

      <div class="lightbox-frame">
        <img class="img current" />
        <img class="img next" />
      </div>

      <button class="nav next">›</button>
    </div>

    <!-- INTERACTIONS -->
    <script>
      /* fade-in feed */
      document.querySelectorAll(".feed img").forEach(img => {
        if (img.complete) img.classList.add("loaded");
        else img.addEventListener("load", () => img.classList.add("loaded"));
      });

      const lightbox = document.getElementById("lightbox");
      const btnPrev = lightbox.querySelector(".prev");
      const btnNext = lightbox.querySelector(".next");
      const btnClose = lightbox.querySelector(".close");

      const imgCurrent = lightbox.querySelector(".img.current");
      const imgNext = lightbox.querySelector(".img.next");

      let images = [];
      let index = 0;

      function preload(i) {
        if (!images[i]) return;
        const img = new Image();
        img.src = images[i];
      }

      function show(newIndex, direction = "right") {
        if (newIndex < 0 || newIndex >= images.length) return;

        const enter = direction === "right" ? "enter-right" : "enter-left";
        const exit = direction === "right" ? "exit-left" : "exit-right";

        imgNext.src = images[newIndex];
        imgNext.className = `img next ${enter}`;

        void imgNext.offsetWidth;

        imgCurrent.classList.add("animate", exit);
        imgNext.classList.add("animate");
        imgNext.style.opacity = "1";

        setTimeout(() => {
          imgCurrent.src = imgNext.src;
          imgCurrent.className = "img current";
          imgNext.className = "img next";
          imgNext.style.opacity = "0";
        }, 350);

        index = newIndex;
        btnPrev.style.display = index > 0 ? "block" : "none";
        btnNext.style.display = index < images.length - 1 ? "block" : "none";

        preload(index + 1);
        preload(index - 1);
      }

      document.querySelectorAll(".feed img").forEach(img => {
        img.addEventListener("click", () => {
          images = JSON.parse(img.dataset.images);
          index = 0;
          imgCurrent.src = images[0];
          lightbox.style.display = "flex";
          btnPrev.style.display = "none";
          btnNext.style.display = images.length > 1 ? "block" : "none";
          preload(1);
        });
      });

      btnPrev.onclick = e => {
        e.stopPropagation();
        show(index - 1, "left");
      };

      btnNext.onclick = e => {
        e.stopPropagation();
        show(index + 1, "right");
      };

      btnClose.onclick = e => {
        e.stopPropagation();
        lightbox.style.display = "none";
      };

      lightbox.onclick = () => {
        lightbox.style.display = "none";
      };
    </script>
  </body>
</html>
