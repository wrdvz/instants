---
import { Client } from "@notionhq/client";
import "../styles/main.css";

const { NOTION_API_KEY, NOTION_DATABASE_ID } = Astro.locals.runtime.env;

const notion = new Client({ auth: NOTION_API_KEY });

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: { property: "Published", checkbox: { equals: true } },
  sorts: [{ property: "Order", direction: "ascending" }],
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      images: imageProp.files.map(f => f.file?.url || f.external?.url),
    };
  })
  .filter(Boolean);

---
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <!-- FEED -->
    <main class="feed">
      {instants.map(i => (
        <img
          src={i.images[0]}
          alt={i.title}
          loading="eager"
          data-images={JSON.stringify(i.images)}
        />
      ))}
    </main>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="lightbox">
  <button class="close">←</button>

  <div class="lightbox-frame">
    <img class="img current" />
    <img class="img next" />
  </div>

<div class="dots"></div>

  <button class="nav prev">‹</button>
  <button class="nav next">›</button>
</div>



    <!-- INTERACTIONS -->
    <script>
/* fade-in feed */
document.querySelectorAll(".feed img").forEach(img => {
  if (img.complete) img.classList.add("loaded");
  else img.addEventListener("load", () => img.classList.add("loaded"));
});

const lightbox = document.getElementById("lightbox");
const frame = document.querySelector(".lightbox-frame");
const imgCurrent = frame.querySelector(".img.current");
const imgNext = frame.querySelector(".img.next");
const btnPrev = lightbox.querySelector(".prev");
const btnNext = lightbox.querySelector(".next");
const btnClose = lightbox.querySelector(".close");
const dotsContainer = lightbox.querySelector(".dots");

let images = [];
let index = 0;

let startX = 0;
let deltaX = 0;
let dragging = false;
let swipeTarget = null;

const THRESHOLD = 0.25;

/* ---------- Dots ---------- */

function renderDots() {
  dotsContainer.innerHTML = "";
  images.forEach((_, i) => {
    const dot = document.createElement("div");
    dot.className = "dot" + (i === index ? " active" : "");
    dotsContainer.appendChild(dot);
  });
}

function updateDots() {
  dotsContainer.querySelectorAll(".dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === index);
  });
}

/* ---------- Lightbox ---------- */

function openLightbox(imgs) {
  images = imgs;
  index = 0;
  imgCurrent.src = images[0];
  imgCurrent.style.transform = "translateX(0)";
  imgNext.style.opacity = "0";
  lightbox.style.display = "flex";
  updateButtons();
  renderDots();
  preload(1);
}

function closeLightbox() {
  lightbox.style.display = "none";
  images = [];
}

function updateButtons() {
  btnPrev.style.display = index > 0 ? "block" : "none";
  btnNext.style.display = index < images.length - 1 ? "block" : "none";
}

function preload(i) {
  if (!images[i]) return;
  const img = new Image();
  img.src = images[i];
}

/* ---------- Swipe ---------- */

frame.addEventListener("touchstart", e => {
  if (!images.length) return;

  dragging = true;
  startX = e.touches[0].clientX;
  deltaX = 0;
  swipeTarget = null;

  imgCurrent.style.transition = "none";
  imgNext.style.transition = "none";
});

frame.addEventListener("touchmove", e => {
  if (!dragging) return;

  deltaX = e.touches[0].clientX - startX;
  const width = frame.offsetWidth;

  const goingLeft = deltaX < 0;
  const atStart = index === 0;
  const atEnd = index === images.length - 1;

  if ((atStart && !goingLeft) || (atEnd && goingLeft)) {
    deltaX *= 0.35;
    imgCurrent.style.transform = `translateX(${deltaX}px)`;
    return;
  }

  const direction = goingLeft ? 1 : -1;
  const target = index + direction;

  if (!images[target]) return;

  if (swipeTarget !== target) {
    swipeTarget = target;
    imgNext.src = images[target];
    imgNext.style.opacity = "1";
  }

  imgCurrent.style.transform = `translateX(${deltaX}px)`;
  imgNext.style.transform =
    `translateX(${deltaX > 0 ? deltaX - width : deltaX + width}px)`;
});

frame.addEventListener("touchend", () => {
  if (!dragging) return;
  dragging = false;

  const width = frame.offsetWidth;
  const progress = Math.abs(deltaX) / width;

  const goingLeft = deltaX < 0;
  const atStart = index === 0;
  const atEnd = index === images.length - 1;

  imgCurrent.style.transition = "transform 0.35s ease";
  imgNext.style.transition = "transform 0.35s ease";

  if ((atStart && !goingLeft) || (atEnd && goingLeft)) {
    cancelSwipe();
    return;
  }

  if (progress > THRESHOLD) {
    commitSwipe(goingLeft ? 1 : -1);
  } else {
    cancelSwipe();
  }
});

function commitSwipe(direction) {
  const width = frame.offsetWidth;

  imgCurrent.style.transform =
    `translateX(${direction > 0 ? -width : width}px)`;
  imgNext.style.transform = "translateX(0)";

  setTimeout(() => {
    index += direction;
    imgCurrent.src = imgNext.src;
    resetImages();
    updateButtons();
    updateDots();
    preload(index + 1);
    preload(index - 1);
  }, 350);
}

function cancelSwipe() {
  imgCurrent.style.transform = "translateX(0)";
  imgNext.style.transform = "";
  imgNext.style.opacity = "0";

  setTimeout(() => {
    imgCurrent.style.transition = "";
    imgNext.style.transition = "";
    imgCurrent.style.transform = "";
    imgNext.style.transform = "";
    imgNext.style.opacity = "0";
    swipeTarget = null;
  }, 350);
}

function resetImages() {
  imgCurrent.style.transition = "";
  imgNext.style.transition = "";
  imgCurrent.style.transform = "";
  imgNext.style.transform = "";
  imgNext.style.opacity = "0";
  swipeTarget = null;
}

/* ---------- Controls ---------- */

btnPrev.onclick = e => {
  e.stopPropagation();
  if (index > 0) commitSwipe(-1);
};

btnNext.onclick = e => {
  e.stopPropagation();
  if (index < images.length - 1) commitSwipe(1);
};

btnClose.onclick = e => {
  e.stopPropagation();
  closeLightbox();
};



/* feed */
document.querySelectorAll(".feed img").forEach(img => {
  img.addEventListener("click", () => {
    openLightbox(JSON.parse(img.dataset.images));
  });
});
</script>

  </body>
</html>
