---
import { Client } from "@notionhq/client";

const notion = new Client({
  auth: import.meta.env.NOTION_API_KEY,
});

const databaseId = import.meta.env.NOTION_DATABASE_ID;

const response = await notion.databases.query({
  database_id: databaseId,
  filter: {
    property: "Published",
    checkbox: { equals: true },
  },
  sorts: [
    {
      property: "Order",
      direction: "ascending",
    },
  ],
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;

    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    const image = imageProp.files[0];

    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      imageUrl: image.file?.url || image.external?.url,
    };
  })
  .filter(Boolean);
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <link rel="stylesheet" href="/src/styles/main.css" />
  </head>
  <body>
    <main class="feed">
      {instants.map(i => (
        <img src={i.imageUrl} alt={i.title} loading="lazy" />
      ))}
    </main>
  </body>
</html>
