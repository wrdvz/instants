---
import { Client } from "@notionhq/client";
import "../styles/main.css";

const { NOTION_API_KEY, NOTION_DATABASE_ID } = Astro.locals.runtime.env;

const notion = new Client({
  auth: NOTION_API_KEY,
});

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true },
  },
  sorts: [{ property: "Order", direction: "ascending" }],
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    const image = imageProp.files[0];
    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      imageUrl: image.file?.url || image.external?.url,
    };
  })
  .filter(Boolean);
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
  </head>

  <body>
    <main class="feed">
      {instants.map(i => (
        <img
          src={i.imageUrl}
          alt={i.title}
          loading="lazy"
        />
      ))}
    </main>

    <!-- Lightbox -->
    <div id="lightbox" hidden>
      <img />
    </div>

    <script>
      // fade-in images
      document.querySelectorAll(".feed img").forEach(img => {
        if (img.complete) {
          img.classList.add("loaded");
        } else {
          img.addEventListener("load", () => {
            img.classList.add("loaded");
          });
        }
      });

      // lightbox
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = lightbox.querySelector("img");

      document.querySelectorAll(".feed img").forEach(img => {
        img.addEventListener("click", () => {
          lightboxImg.src = img.src;
          lightbox.hidden = false;
        });
      });

      lightbox.addEventListener("click", () => {
        lightbox.hidden = true;
        lightboxImg.src = "";
      });
    </script>
  </body>
</html>
