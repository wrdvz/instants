---
import { Client } from "@notionhq/client";
import "../styles/main.css";

const { NOTION_API_KEY, NOTION_DATABASE_ID } = Astro.locals.runtime.env;

const notion = new Client({
  auth: NOTION_API_KEY,
});

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true },
  },
  sorts: [{ property: "Order", direction: "ascending" }],
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    const image = imageProp.files[0];
    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      imageUrl: image.file?.url || image.external?.url,
    };
  })
  .filter(Boolean);
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <!-- FEED -->
    <main class="feed">
      {instants.map(i => (
        <img
          src={i.imageUrl}
          alt={i.title}
          loading="eager"
        />
      ))}
    </main>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="lightbox">
      <img />
    </div>

    <!-- INTERACTIONS -->
    <script>
      // Fade-in images
      document.querySelectorAll(".feed img").forEach(img => {
        if (img.complete) {
          img.classList.add("loaded");
        } else {
          img.addEventListener("load", () => {
            img.classList.add("loaded");
          });
        }
      });

      // Lightbox
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = lightbox.querySelector("img");

      document.querySelectorAll(".feed img").forEach(img => {
        img.addEventListener("click", () => {
          lightboxImg.src = img.src;
          lightbox.style.display = "flex";
        });
      });

      lightbox.addEventListener("click", () => {
        lightbox.style.display = "none";
        lightboxImg.src = "";
      });
    </script>
  </body>
</html>
