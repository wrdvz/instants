---
import { Client } from "@notionhq/client";
import "../styles/main.css";

/* ===============================
   ENV (Cloudflare Pages compatible)
================================ */

const runtimeEnv = Astro.locals?.runtime?.env ?? {};
const buildEnv = import.meta.env ?? {};

const NOTION_API_KEY =
  runtimeEnv.NOTION_API_KEY || buildEnv.NOTION_API_KEY;

const NOTION_DATABASE_ID =
  runtimeEnv.NOTION_DATABASE_ID || buildEnv.NOTION_DATABASE_ID;

const NOTION_PROFILE_DATABASE_ID =
  runtimeEnv.NOTION_PROFILE_DATABASE_ID || buildEnv.NOTION_PROFILE_DATABASE_ID;

if (!NOTION_API_KEY || !NOTION_DATABASE_ID || !NOTION_PROFILE_DATABASE_ID) {
  console.error("ENV MISSING", {
    NOTION_API_KEY: !!NOTION_API_KEY,
    NOTION_DATABASE_ID,
    NOTION_PROFILE_DATABASE_ID
  });
  throw new Error("Missing environment variables");
}

/* ===============================
   NOTION CLIENT
================================ */

const notion = new Client({ auth: NOTION_API_KEY });

/* ===============================
   INSTANTS
================================ */

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true }
  },
  sorts: [
    { property: "Order", direction: "ascending" }
  ]
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      images: imageProp.files.map(
        f => f.file?.url || f.external?.url
      )
    };
  })
  .filter(Boolean);

/* ===============================
   PROFILE
================================ */

const profileRes = await notion.databases.query({
  database_id: NOTION_PROFILE_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true }
  }
});

const profilePage = profileRes.results[0] ?? null;

const profile = profilePage
  ? {
      name: profilePage.properties.Username?.title?.[0]?.plain_text ?? "",
      bio: profilePage.properties.Bio?.rich_text ?? [],
      link: profilePage.properties.Website?.url ?? "",
      avatar:
        profilePage.properties.Avatar?.files?.[0]?.file?.url ||
        profilePage.properties.Avatar?.files?.[0]?.external?.url ||
        ""
    }
  : null;
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>

    {profile ? (
  <header class="profile">
    <img
      class="avatar"
      src={profile.avatar}
      alt={profile.name}
      loading="eager"
    />

    <div class="profile-meta">
      <h1>{profile.name}</h1>

      <div class="bio">
        {profile.bio.length > 0 &&
          profile.bio.map((b) => (
            <p>{b.plain_text}</p>
          ))}
      </div>

      {profile.link && (
        <a href={profile.link} target="_blank" rel="noopener">
          {profile.link}
        </a>
      )}
    </div>
  </header>
) : null}

    <main class="feed">
      {instants.map(i => (
        <img
          src={i.images[0]}
          alt={i.title}
          loading="eager"
          data-images={JSON.stringify(i.images)}
        />
      ))}
    </main>

    <div id="lightbox" class="lightbox">
      <button class="close">‚Üê</button>

      <div class="lightbox-frame">
        <img class="img current" />
        <img class="img next" />
      </div>

      <div class="dots"></div>

      <button class="nav prev">‚Äπ</button>
      <button class="nav next">‚Ä∫</button>
    </div>

   <script>
/* fade-in feed */
document.querySelectorAll(".feed img").forEach(img => {
  if (img.complete) img.classList.add("loaded");
  else img.addEventListener("load", () => img.classList.add("loaded"));
});

const lightbox = document.getElementById("lightbox");
const frame = document.querySelector(".lightbox-frame");
const imgCurrent = frame.querySelector(".img.current");
const imgNext = frame.querySelector(".img.next");
const btnPrev = lightbox.querySelector(".prev");
const btnNext = lightbox.querySelector(".next");
const btnClose = lightbox.querySelector(".close");
const dotsContainer = lightbox.querySelector(".dots");

let images = [];
let index = 0;

let startX = 0;
let startY = 0;
let deltaX = 0;
let deltaY = 0;
let dragging = false;
let locked = false; // ‚Üê cl√©

const THRESHOLD = 0.25;

/* ---------- Dots ---------- */

function renderDots() {
  dotsContainer.innerHTML = "";
  images.forEach((_, i) => {
    const dot = document.createElement("div");
    dot.className = "dot" + (i === index ? " active" : "");
    dotsContainer.appendChild(dot);
  });
}

function updateDots() {
  dotsContainer.querySelectorAll(".dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === index);
  });
}

/* ---------- Lightbox ---------- */

function openLightbox(imgs) {
  images = imgs;
  index = 0;
  imgCurrent.src = images[0];
  imgCurrent.style.transform = "translateX(0)";
  imgNext.style.opacity = "0";
  lightbox.style.display = "flex";
  updateButtons();
  renderDots();
  preload(1);
}

function closeLightbox() {
  lightbox.style.display = "none";
  images = [];
}

function updateButtons() {
  btnPrev.style.display = index > 0 ? "block" : "none";
  btnNext.style.display = index < images.length - 1 ? "block" : "none";
}

function preload(i) {
  if (!images[i]) return;
  const img = new Image();
  img.src = images[i];
}

/* ---------- Swipe ---------- */

frame.addEventListener("touchstart", e => {
  if (!images.length) return;

  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;

  deltaX = 0;
  deltaY = 0;
  dragging = true;
  locked = false;

  imgCurrent.style.transition = "none";
  imgNext.style.transition = "none";
});

frame.addEventListener("touchmove", e => {
  if (!dragging) return;

  const t = e.touches[0];
  deltaX = t.clientX - startX;
  deltaY = t.clientY - startY;

  // üîí D√©tection d'intention
  if (!locked) {
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
      locked = true; // swipe horizontal
    } else {
      return; // geste vertical ‚Üí on ignore
    }
  }

  // √Ä partir d‚Äôici : swipe horizontal ‚Üí on bloque Safari
  e.preventDefault();

  const width = frame.offsetWidth;
  const goingLeft = deltaX < 0;
  const atStart = index === 0;
  const atEnd = index === images.length - 1;

  // r√©sistance aux bords
  if ((atStart && !goingLeft) || (atEnd && goingLeft)) {
    imgCurrent.style.transform = `translateX(${deltaX * 0.35}px)`;
    return;
  }

  const direction = goingLeft ? 1 : -1;
  const target = index + direction;
  if (!images[target]) return;

  imgNext.src = images[target];
  imgNext.style.opacity = "1";

  imgCurrent.style.transform = `translateX(${deltaX}px)`;
  imgNext.style.transform =
    `translateX(${deltaX > 0 ? deltaX - width : deltaX + width}px)`;
});

frame.addEventListener("touchend", () => {
  if (!dragging) return;
  dragging = false;

  const width = frame.offsetWidth;
  const progress = Math.abs(deltaX) / width;

  const goingLeft = deltaX < 0;
  const atStart = index === 0;
  const atEnd = index === images.length - 1;

  imgCurrent.style.transition = "transform 0.35s ease";
  imgNext.style.transition = "transform 0.35s ease";

  if ((atStart && !goingLeft) || (atEnd && goingLeft)) {
    cancelSwipe();
    return;
  }

  if (progress > THRESHOLD) {
    commitSwipe(goingLeft ? 1 : -1);
  } else {
    cancelSwipe();
  }
});

function commitSwipe(direction) {
  const width = frame.offsetWidth;

  imgCurrent.style.transform =
    `translateX(${direction > 0 ? -width : width}px)`;
  imgNext.style.transform = "translateX(0)";

  setTimeout(() => {
    index += direction;
    imgCurrent.src = imgNext.src;
    resetImages();
    updateButtons();
    updateDots();
    preload(index + 1);
    preload(index - 1);
  }, 350);
}

function cancelSwipe() {
  imgCurrent.style.transform = "translateX(0)";
  imgNext.style.transform = "";
  imgNext.style.opacity = "0";

  setTimeout(() => {
    imgCurrent.style.transition = "";
    imgNext.style.transition = "";
    imgCurrent.style.transform = "";
    imgNext.style.transform = "";
    imgNext.style.opacity = "0";
   
  }, 350);
}

function resetImages() {
  imgCurrent.style.transition = "";
  imgNext.style.transition = "";
  imgCurrent.style.transform = "";
  imgNext.style.transform = "";
  imgNext.style.opacity = "0";
  
}

frame.addEventListener("click", e => {
  e.stopPropagation();
});

/* ---------- Controls ---------- */

btnPrev.onclick = e => {
  e.stopPropagation();
  if (index > 0) commitSwipe(-1);
};

btnNext.onclick = e => {
  e.stopPropagation();
  if (index < images.length - 1) commitSwipe(1);
};

btnClose.onclick = e => {
  e.stopPropagation();
  closeLightbox();
};

/* feed */
document.querySelectorAll(".feed img").forEach(img => {
  img.addEventListener("click", () => {
    openLightbox(JSON.parse(img.dataset.images));
  });
});
</script>


  </body>
</html>
