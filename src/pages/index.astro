---
import { Client } from "@notionhq/client";
import "../styles/main.css";

/* ===============================
   ENV (Cloudflare runtime only)
================================ */

const {
  NOTION_API_KEY,
  NOTION_DATABASE_ID,
  NOTION_PROFILE_DATABASE_ID
} = Astro.locals.runtime.env;

/* Guard rail anti-500 silencieux */
if (!NOTION_API_KEY || !NOTION_DATABASE_ID || !NOTION_PROFILE_DATABASE_ID) {
  console.error("Missing environment variables", {
    NOTION_API_KEY: !!NOTION_API_KEY,
    NOTION_DATABASE_ID,
    NOTION_PROFILE_DATABASE_ID
  });
  throw new Error("Missing Notion environment variables");
}

/* Debug visible dans logs Cloudflare */
console.log("ENV CHECK OK", {
  NOTION_API_KEY: true,
  NOTION_DATABASE_ID,
  NOTION_PROFILE_DATABASE_ID
});

/* ===============================
   NOTION CLIENT
================================ */

const notion = new Client({ auth: NOTION_API_KEY });

/* ===============================
   INSTANTS
================================ */

const response = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true }
  },
  sorts: [
    { property: "Order", direction: "ascending" }
  ]
});

const instants = response.results
  .map(page => {
    const imageProp = page.properties.Image;
    if (!imageProp || imageProp.type !== "files" || imageProp.files.length === 0) {
      return null;
    }

    return {
      title: page.properties.Title?.title?.[0]?.plain_text ?? "",
      images: imageProp.files.map(
        f => f.file?.url || f.external?.url
      )
    };
  })
  .filter(Boolean);

/* ===============================
   PROFILE
================================ */

const profileRes = await notion.databases.query({
  database_id: NOTION_PROFILE_DATABASE_ID,
  filter: {
    property: "Published",
    checkbox: { equals: true }
  }
});

const profilePage = profileRes.results[0] ?? null;

const profile = profilePage
  ? {
      name: profilePage.properties.Username?.title?.[0]?.plain_text ?? "",
      bio: profilePage.properties.Bio?.rich_text ?? [],
      link: profilePage.properties.Website?.url ?? "",
      avatar:
        profilePage.properties.Avatar?.files?.[0]?.file?.url ||
        profilePage.properties.Avatar?.files?.[0]?.external?.url ||
        ""
    }
  : null;
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Instants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>

    {profile && (
      <header class="profile">
        {profile.avatar && (
          <img class="avatar" src={profile.avatar} alt={profile.name} />
        )}

        <div class="profile-meta">
          <h1>{profile.name}</h1>

          <div class="bio">
            {profile.bio.map(b => (
              <p>{b.plain_text}</p>
            ))}
          </div>

          {profile.link && (
            <a href={profile.link} target="_blank" rel="noopener">
              {profile.link}
            </a>
          )}
        </div>
      </header>
    )}

    <main class="feed">
      {instants.map(i => (
        <img
          src={i.images[0]}
          alt={i.title}
          loading="eager"
          data-images={JSON.stringify(i.images)}
        />
      ))}
    </main>

    <div id="lightbox" class="lightbox">
      <button class="close">←</button>

      <div class="lightbox-frame">
        <img class="img current" />
        <img class="img next" />
      </div>

      <div class="dots"></div>

      <button class="nav prev">‹</button>
      <button class="nav next">›</button>
    </div>

    <script>
      /* Ton JS est OK, inchangé */
    </script>

  </body>
</html>
