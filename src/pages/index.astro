---
/* ======================================================
   SECTION A â€” CONFIG & IMPORTS (serveur)
   - Cette partie tourne cÃ´tÃ© serveur (Astro)
   - Elle ne sera JAMAIS exÃ©cutÃ©e dans le navigateur
====================================================== */

import { Client } from "@notionhq/client";
import "../styles/main.css";



/* ======================================================
   SECTION B â€” VARIABLES Dâ€™ENVIRONNEMENT
   - Permet de fonctionner en local ET sur Cloudflare
====================================================== */

const runtimeEnv = Astro.locals?.runtime?.env ?? {};
const buildEnv = import.meta.env ?? {};

const NOTION_API_KEY =
  runtimeEnv.NOTION_API_KEY || buildEnv.NOTION_API_KEY;
const NOTION_DATABASE_ID =
  runtimeEnv.NOTION_DATABASE_ID || buildEnv.NOTION_DATABASE_ID;
const NOTION_PROFILE_DATABASE_ID =
  runtimeEnv.NOTION_PROFILE_DATABASE_ID || buildEnv.NOTION_PROFILE_DATABASE_ID;

if (!NOTION_API_KEY || !NOTION_DATABASE_ID || !NOTION_PROFILE_DATABASE_ID) {
  throw new Error("Missing environment variables");
}

/* ======================================================
   SECTION C â€” CLIENT NOTION
====================================================== */

const notion = new Client({ auth: NOTION_API_KEY });

/* ======================================================
   SECTION D â€” RÃ‰CUPÃ‰RATION DES POSTS
   - On transforme la rÃ©ponse Notion en donnÃ©es simples
   - Le HTML ne connaÃ®tra JAMAIS Notion directement
====================================================== */

const postsRes = await notion.databases.query({
  database_id: NOTION_DATABASE_ID,
  filter: { property: "Published", checkbox: { equals: true } },
  sorts: [{ property: "Order", direction: "ascending" }]
});

const posts = postsRes.results
  .map((page) => {
    const files = page.properties.Image?.files;
    
    const images = files
  .map(f => f.file?.url || f.external?.url)
  .filter(Boolean);

if (!images.length) return null;

    return {
      images: files
  .map(f => f.file?.url || f.external?.url)
  .filter(Boolean),
      caption: page.properties.Caption?.rich_text?.[0]?.plain_text ?? "",
      date: page.properties.Date?.date?.start ?? ""
    };
  })
  .filter(Boolean);

  

/* ======================================================
   SECTION E â€” RÃ‰CUPÃ‰RATION DU PROFIL
====================================================== */

const profileRes = await notion.databases.query({
  database_id: NOTION_PROFILE_DATABASE_ID,
  filter: { property: "Published", checkbox: { equals: true } }
});

const profilePage = profileRes.results[0];
const profile = {
  name: profilePage.properties.Username.title[0].plain_text,
  bio: profilePage.properties.Bio.rich_text,
  avatar:
    profilePage.properties.Avatar.files[0].file?.url ||
    profilePage.properties.Avatar.files[0].external?.url
};
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- ======================================================
       SECTION F â€” HEAD HTML
       - Fonts
       - Meta viewport (important pour iOS)
  ====================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instants</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
</head>



<body>

<!-- ======================================================
     SECTION G â€” HEADER HOME (profil)
====================================================== -->

<header class="profile">
  <img class="avatar" src={profile.avatar} alt={profile.name} />

  <div class="profile-text">
    <h1>{profile.name}</h1>
    {profile.bio.map(b => <p>{b.plain_text}</p>)}
  </div>

  <button class="contact-btn" aria-label="Me contacter">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12
           59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
    </svg>
  </button>
</header>

<!-- ======================================================
     SECTION H â€” FEED (grille dâ€™images)
     - Chaque image contient ses donnÃ©es en data-*
====================================================== -->
<main class="feed">
  {posts.map(p => (
    <img
      src={p.images[0]}
      alt=""
      data-images={JSON.stringify(p.images)}
      data-caption={p.caption}
      data-date={p.date}
    />
  ))}
</main>

<div class="contact-sheet">
  <div class="contact-sheet-backdrop"></div>
  <div class="contact-sheet-panel">
    <button class="sheet-action mail">Envoyer un mail</button>
    <button class="sheet-action copy">Copier lâ€™adresse</button>
    <button class="sheet-cancel">Annuler</button>
  </div>
</div>

<!-- ======================================================
  SECTION I â€” OVERLAY POST (lightbox)
====================================================== -->
<div id="lightbox" class="lightbox">

  <!-- I.1 â€” Topbar -->
  <div class="post-topbar">
    
<div id="backBtn" class="topbar-back" role="button" aria-label="Retour">
   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
  <path fill-rule="evenodd" d="M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
</svg>
</div>
    <div class="topbar-title">Post</div>
  </div>

  <!-- I.2 â€” Contenu scrollable -->
  <div class="post">

    <!-- I.2.a â€” Header post -->
    <div class="post-header">
      <img class="post-avatar" src={profile?.avatar} />
      <div class="post-user">
        <div class="post-username">{profile?.name}</div>
        <div class="post-date"></div>
      </div>
    </div>

    <!-- I.2.b â€” Image + carousel -->
    <div class="image-wrapper">
      <img class="img current" />
      <img class="img next" />
      <div class="glass"></div>

      <button class="nav prev icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
  <path fill-rule="evenodd" d="M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
</svg>

      </button>
      <button class="nav next icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
  <path fill-rule="evenodd" d="M6.22 4.22a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.75.75 0 0 1-1.06-1.06L8.94 8 6.22 5.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
</svg>
      </button>
    </div>

    <!-- I.2.c â€” Actions -->
    <div class="actions">
      <button class="icon-btn like-btn">
        <svg 
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 24 24"
  class="icon-outline"
  stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
</svg>
      </button>
    </div>

    <!-- I.2.d â€” Caption -->
    <div class="post-meta">
      <p class="post-caption"></p>
    </div>

   


<!-- ======================================================
     SECTION J â€” SCRIPT CLIENT (interactions)
====================================================== -->
<script>
(() => {


  
  document.addEventListener("DOMContentLoaded", () => {

    /* =========================
       DOM
    ========================= */

   
    const lightbox = document.getElementById("lightbox");
    const frame = document.querySelector(".image-wrapper");
    const imgCurrent = document.querySelector(".img.current");
    const imgNext = document.querySelector(".img.next");
    const captionEl = document.querySelector(".post-caption");
    const dateEl = document.querySelector(".post-date");
    const backBtn = document.getElementById("backBtn");
    const likeBtn = document.querySelector(".like-btn");
    const prevBtn = document.querySelector(".nav.prev");
    const nextBtn = document.querySelector(".nav.next");
    const glass = document.querySelector(".glass");
    const PANEL_EASING = "cubic-bezier(0.22,1,0.36,1)";
    const PANEL_DURATION = 0.5; // en secondes
    
    const contactBtn = document.querySelector(".contact-btn");
    const sheet = document.querySelector(".contact-sheet");
    const backdrop = document.querySelector(".contact-sheet-backdrop");
    const cancelBtn = document.querySelector(".sheet-cancel");

    const mailBtn = document.querySelector(".sheet-action.mail");
    const copyBtn = document.querySelector(".sheet-action.copy");
    const email = "edward.vizard@icloud.com";

  

function openSheet() {
  console.log("ðŸŸ¢ openSheet()");
  sheet.classList.add("is-open");
  document.body.classList.add("sheet-open");
}

function closeSheet() {
  console.log("ðŸ”´ closeSheet()");
  sheet.classList.remove("is-open");
  document.body.classList.remove("sheet-open");
}

contactBtn.addEventListener("click", e => {
  e.stopPropagation();
  openSheet();
});

mailBtn.addEventListener("click", () => {
  closeSheet();

  setTimeout(() => {
    const subject = "Contact";
    const body = "";

    window.location.href =
      `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }, 150);
});

copyBtn.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(email);

    closeSheet();

    console.log("ðŸ“‹ Email copiÃ© :", email);
  } catch (err) {
    console.error("âŒ Impossible de copier", err);
  }
});

backdrop.addEventListener("click", closeSheet);
cancelBtn.addEventListener("click", closeSheet);

    if (!lightbox || !frame || !imgCurrent) return;

    /* =========================
       STATE
    ========================= */
    let images = [];
    let index = 0;
    let isAnimating = false;
    const loadedImages = new Set();

    /* =========================
       HELPERS
    ========================= */
    function resetImages() {
  imgCurrent.style.opacity = "1";       
  imgNext.style.transition = "";
  imgNext.style.transform = "";
  imgNext.style.opacity = "0";
  imgNext.classList.remove("loading");

  
}

    function goToImage(direction, startX = 0) {
  if (isAnimating) return;

  const target = index + direction;
  if (!images[target]) return;

  isAnimating = true;

  index = target;
    updateNav();

  const width = frame.offsetWidth;
  const src = images[target];
  const needsLoading = !loadedImages.has(src);

  imgNext.src = src;
  imgNext.style.opacity = "1";

  if (needsLoading) {
    glass.style.opacity = "1";
  }

  // figer la position EXACTE du drag
  imgCurrent.style.transition = "none";
  imgNext.style.transition = "none";

  imgCurrent.style.transform = `translateX(${startX}px)`;
  imgNext.style.transform =
    `translateX(${startX + (direction > 0 ? width : -width)}px)`;

  // forcer le layout
  imgCurrent.offsetHeight;

  // animation unique
  imgCurrent.style.transition =
    "transform 0.35s cubic-bezier(0.22,1,0.36,1)";
  imgNext.style.transition =
    "transform 0.35s cubic-bezier(0.22,1,0.36,1)";

  imgCurrent.style.transform =
    `translateX(${direction > 0 ? -width : width}px)`;
  imgNext.style.transform = "translateX(0)";

  setTimeout(() => {
    imgCurrent.src = src;
    imgCurrent.style.transform = "translateX(0)";
    imgCurrent.style.transition = "";

    imgNext.style.opacity = "0";
    imgNext.style.transition = "";
    imgNext.style.transform = "";

    loadedImages.add(src);
    glass.style.opacity = "0";

    
    isAnimating = false;
  }, 350);
}

function cancelSwipe(direction) {
  const width = frame.offsetWidth;

  imgCurrent.style.transition =
    "transform 0.25s cubic-bezier(0.22,1,0.36,1)";
  imgNext.style.transition =
    "transform 0.25s cubic-bezier(0.22,1,0.36,1)";

  imgCurrent.style.transform = "translateX(0)";
  imgNext.style.transform =
    `translateX(${direction > 0 ? width : -width}px)`;

  glass.style.opacity = "0";

  setTimeout(() => {
    imgNext.style.opacity = "0";
    imgNext.style.transition = "";
    imgNext.style.transform = "";
  }, 250);
}


  function rubberBand() {
  imgCurrent.style.transition =
    "transform 0.35s cubic-bezier(0.22,1,0.36,1)";
  imgCurrent.style.transform = "translateX(0)";
}

let gesture = null; // "horizontal" | "vertical" | null
const LOCK_THRESHOLD = 8;

function preloadImages(imageUrls) {
  return Promise.all(
    imageUrls.map(src => {
      if (loadedImages.has(src)) return Promise.resolve();

      const img = new Image();
      img.src = src;

      return img.decode()
        .then(() => {
          loadedImages.add(src);
        })
        .catch(() => {});
    })
  );
}

function updateNav() {
  // sâ€™il nâ€™y a quâ€™une image â†’ aucune flÃ¨che
  if (images.length <= 1) {
    prevBtn.style.display = "none";
    nextBtn.style.display = "none";
    return;
  }

  // flÃ¨che gauche
  prevBtn.style.display = index > 0 ? "flex" : "none";

  // flÃ¨che droite
  nextBtn.style.display = index < images.length - 1 ? "flex" : "none";
}




    /* =========================
       OPEN POST
    ========================= */


    document.querySelectorAll(".feed img").forEach(img => {
  img.addEventListener("click", (e) => {
    e.stopPropagation();

    

    images = JSON.parse(img.dataset.images);
    index = 0;
    updateNav();

    imgCurrent.src = images[0];
    imgCurrent.classList.add("loading");

    loadedImages.add(images[0]);

    captionEl.textContent = img.dataset.caption || "";
    if (dateEl) dateEl.textContent = img.dataset.date || "";

    lightbox.style.display = "block";
    lightbox.style.transition = "none";
    lightbox.style.transform = "translateX(100%)";
    lightbox.offsetHeight;
    lightbox.style.transition =
      `transform ${PANEL_DURATION}s ${PANEL_EASING}`;
    lightbox.style.transform = "translateX(0)";

    document.body.style.overflow = "hidden";

    preloadImages(images).then(() => {
      imgCurrent.classList.remove("loading");
    });
  });
});




    /* =========================
       CLOSE
    ========================= */

  

    backBtn.addEventListener("click", () => {

     

  // 1ï¸âƒ£ forcer la position de dÃ©part EXACTE (plein Ã©cran)
  lightbox.style.transition = "none";
  lightbox.style.transform = "translateX(0)";

  // forcer le layout
  lightbox.offsetHeight;

  // 2ï¸âƒ£ lancer lâ€™animation de sortie
  lightbox.style.transition =
  `transform ${PANEL_DURATION}s ${PANEL_EASING}`;
  lightbox.style.transform = "translateX(100%)";

  // 3ï¸âƒ£ cleanup aprÃ¨s animation
  setTimeout(() => {
    lightbox.style.display = "none";
    lightbox.style.transition = "";
    lightbox.style.transform = "";
  }, 350);

  // reset UI
  prevBtn.style.display = "none";
  nextBtn.style.display = "none";
  document.body.style.overflow = "";

});
    

    /* =========================
       BUTTONS
    ========================= */
    prevBtn.addEventListener("click", e => {
      e.stopPropagation();
      goToImage(-1);
    });

    nextBtn.addEventListener("click", e => {
      e.stopPropagation();
      goToImage(1);
    });

    /* =========================
       LIKE
    ========================= */
    likeBtn?.addEventListener("click", () => {
      likeBtn.classList.toggle("liked");
    });

    /* =========================
       SWIPE iOS
    ========================= */
    let startX = 0;
let startY = 0;
let deltaX = 0;
let deltaY = 0; 
    let dragging = false;

  
  frame.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
  deltaX = 0;
  deltaY = 0;
  dragging = true;
  gesture = null;

  glass.style.opacity = "0";

  imgCurrent.style.transition = "none";
  imgNext.style.transition = "none";
}, { passive: true });


    frame.addEventListener("touchmove", e => {
  if (!dragging || isAnimating) return;

  deltaX = e.touches[0].clientX - startX;
  deltaY = e.touches[0].clientY - startY;

  // tant quâ€™on nâ€™a pas dÃ©cidÃ©, on observe
  if (!gesture) {
    if (
      Math.abs(deltaX) < LOCK_THRESHOLD &&
      Math.abs(deltaY) < LOCK_THRESHOLD
    ) {
      return;
    }

    gesture =
      Math.abs(deltaX) > Math.abs(deltaY)
        ? "horizontal"
        : "vertical";
  }

  // GESTE VERTICAL â†’ on laisse le scroll vivre sa vie
  if (gesture === "vertical") {
    return;
  }

  // GESTE HORIZONTAL â†’ on bloque le scroll
  e.preventDefault();

  const width = frame.offsetWidth;
  const direction = deltaX < 0 ? 1 : -1;
  const target = index + direction;

  let x = deltaX;
  const limit = 30;

  if (!images[target] && Math.abs(deltaX) > limit) {
    const overflow = Math.abs(deltaX) - limit;
    x =
      Math.sign(deltaX) *
      (limit + Math.sqrt(overflow) * 6);
  }

  imgCurrent.style.transform = `translateX(${x}px)`;

  if (images[target]) {
    imgNext.src = images[target];
    imgNext.style.opacity = "1";
    imgNext.style.transform =
      `translateX(${x + (direction > 0 ? width : -width)}px)`;
  }
}, { passive: false });

    frame.addEventListener("touchend", () => {
  if (!dragging) return;

  dragging = false;

  if (gesture !== "horizontal") return;

  const width = frame.offsetWidth;
  const progress = Math.abs(deltaX) / width;
  const direction = deltaX < 0 ? 1 : -1;
  const target = index + direction;

  if (progress > 0.2 && images[target]) {
  goToImage(direction, deltaX);
} else {
  cancelSwipe(direction);

}
});

  });

})();




</script>



</body>
</html>